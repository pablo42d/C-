

@using System.Data
@model DataTable

<div class="container mt-4">
@*<div class="container-fluid mt-4">*@
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-file-invoice-dollar"></i> Raporty Bilingowe Goodyear</h2>
        <div class="btn-group shadow-sm">
            <button onclick="pobierzRaport()" class="btn btn-success">
                <i class="fas fa-file-csv"></i> Eksportuj do CSV
            </button>
            @* Dodatkowy przycisk dla raportu *@
            <a href="@Url.Action("RaportKsiegowy", "Administrator")" class="btn btn-outline-success">
                <i class="fas fa-calculator"></i> Podsumowanie Działów
            </a>
        </div>
    </div>

    @* Panel Zaawansowanych Filtrów *@
    <div class="card shadow-sm mb-4 border-primary">
        <div class="card-header bg-light fw-bold">
            <i class="fas fa-filter text-primary"></i> Parametry wyszukiwania
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Pracownik / Numer</label>
                    <input type="text" name="fraza" value="@Request.QueryString["fraza"]" class="form-control" placeholder="Imię, Nazwisko lub Numer...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">Nr Faktury</label>
                    <input type="text" name="nrFaktury" value="@Request.QueryString["nrFaktury"]" class="form-control" placeholder="FVT/...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">Dział</label>
                    <select name="dzialId" class="form-select">
                        <option value="">Wszystkie działy</option>
                        @foreach (DataRow d in (ViewBag.Dzialy as DataTable).Rows)
                        {
                            <option value="@d["ID"]" @(Request.QueryString["dzialId"] == d["ID"].ToString() ? "selected" : "")>@d["NazwaDzialu"]</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">Manager</label>
                    <input type="text" name="manager" value="@Request.QueryString["manager"]" class="form-control" placeholder="Nazwisko managera...">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Zakres dat (Od - Do)</label>
                    <div class="input-group">
                        <input type="date" name="od" value="@Request.QueryString["od"]" class="form-control">
                        <input type="date" name="doDaty" value="@Request.QueryString["doDaty"]" class="form-control">
                    </div>
                </div>
                <div class="col-12 text-end border-top pt-3">
                    <a href="@Url.Action("Raporty")" class="btn btn-secondary me-2">Wyczyść</a>
                    <button type="submit" class="btn btn-primary px-5">Filtruj bilingi</button>
                </div>
            </form>
        </div>
    </div>

    @* Tabela wyników *@
    <div class="table-responsive shadow-sm rounded border">
        <table id="tabelaRaportu" class="table table-bordered table-hover bg-white mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Data połączenia</th>
                    <th>Numer źródłowy</th>
                    <th>Pracownik</th>
                    <th>Manager</th>
                    <th>Dział</th>
                    <th>Typ</th>
                    <th class="text-end">Netto</th>
                    <th class="text-end">Brutto</th>
                    <th>Nr Faktury</th>
                </tr>
            </thead>
            <tbody>
                @* Sekcja Ostrzeżeń *@
                @if (ViewBag.BrakKomorkowych == true && ViewBag.BrakStacjonarnych == true)
                {
                    <tr class="table-danger">
                        <td colspan="9" class="text-center py-3 fw-bold">
                            ⚠️ Brak jakichkolwiek bilingów w systemie za okres @ViewBag.WybranyMiesiac.@ViewBag.WybranyRok
                        </td>
                    </tr>
                }
                else
                {
                    if (ViewBag.BrakKomorkowych == true)
                    {
                        <tr class="table-warning text-dark">
                            <td colspan="9" class="text-center py-2">
                                <i class="fas fa-mobile-alt"></i> Uwaga: Brak bilingów <strong>komórkowych</strong> za ten miesiąc.
                            </td>
                        </tr>
                    }
                    if (ViewBag.BrakStacjonarnych == true)
                    {
                        <tr class="table-warning text-dark">
                            <td colspan="9" class="text-center py-2">
                                <i class="fas fa-phone-alt"></i> Uwaga: Brak bilingów <strong>stacjonarnych</strong> za ten miesiąc.
                            </td>
                        </tr>
                    }
                }


                @*@if (Model.Rows.Count == 0)
                    {
                        <tr>
                            <td colspan="9" class="text-center py-4 text-muted">Brak bilingów spełniających wybrane kryteria.</td>
                        </tr>
                    }*@


                @foreach (DataRow row in Model.Rows)
                {
                    <tr>
                        <td class="align-middle">@Convert.ToDateTime(row["DataPolaczenia"]).ToString("dd.MM.yyyy HH:mm")</td>
                        <td class="align-middle"><code>@row["NumerTelefonu"]</code></td>
                        <td class="align-middle"><strong>@row["Pracownik"]</strong></td>
                        <td class="align-middle">@row["MenagerName"]</td>
                        <td class="align-middle"><span class="badge bg-light text-dark border">@row["Dzial"]</span></td>
                        <td class="align-middle text-center">
                            <span class="badge @(row["Typ"].ToString() == "Komórkowy" ? "bg-info" : "bg-secondary")">@row["Typ"]</span>
                        </td>
                        <td class="align-middle text-end text-muted">@string.Format("{0:N2}", row["KwotaNetto"]) zł</td>
                        <td class="align-middle text-end fw-bold">@string.Format("{0:N2}", row["KwotaBrutto"]) zł</td>
                        <td class="align-middle small">@row["NrFaktury"]</td>
                    </tr>
                }
            </tbody>
            @if (Model.Rows.Count > 0)
            {
                <tfoot class="table-light fw-bold border-top-2">
                    <tr>
                        <td colspan="7" class="text-end py-3">SUMA BRUTTO DLA WIDOCZNYCH (50) POZYCJI:</td>
                        <td class="text-end py-3 text-primary" style="font-size: 1.1em;">
                            @{
                                var sumaBrutto = Model.AsEnumerable().Sum(x => x.Field<decimal>("KwotaBrutto"));
                            }
                            @string.Format("{0:N2}", sumaBrutto) zł
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            }

            @*<tfoot class="table-light fw-bold border-top-2">
                    <tr>
                        <td colspan="7" class="text-end py-3">ŁĄCZNY KOSZT PRZEFILTROWANYCH POŁĄCZEŃ:</td>
                        <td class="text-end py-3 text-primary" style="font-size: 1.1em;">
                            @{
                                var sumaBrutto = Model.AsEnumerable().Sum(x => x.Field<decimal>("KwotaBrutto"));
                            }
                            @string.Format("{0:N2}", sumaBrutto) zł
                        </td>
                        <td></td>
                    </tr>
                </tfoot>*@

        </table>
    </div>
    @* Paginacja *@
    <div class="mt-3 d-flex justify-content-center">
        <nav>
            <ul class="pagination">
                @* Przycisk Poprzednia *@
                <li class="page-item @(ViewBag.AktualnaStrona <= 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Raporty", new { strona = ViewBag.AktualnaStrona - 1, miesiac = ViewBag.WybranyMiesiac, rok = ViewBag.WybranyRok, fraza = Request.QueryString["fraza"] })">«</a>
                </li>

                @* Numery stron *@
                @for (int i = 1; i <= ViewBag.LiczbaStron; i++)
                {
                    <li class="page-item @(i == ViewBag.AktualnaStrona ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Raporty", new { strona = i, miesiac = ViewBag.WybranyMiesiac, rok = ViewBag.WybranyRok, fraza = Request.QueryString["fraza"] })">@i</a>
                    </li>
                }

                @* Przycisk Następna *@
                <li class="page-item @(ViewBag.AktualnaStrona >= ViewBag.LiczbaStron ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Raporty", new { strona = ViewBag.AktualnaStrona + 1, miesiac = ViewBag.WybranyMiesiac, rok = ViewBag.WybranyRok, fraza = Request.QueryString["fraza"] })">»</a>
                </li>
            </ul>

            @*<ul class="pagination">
                    <li class="page-item @(ViewBag.AktualnaStrona <= 1 ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("Raporty", new { strona = ViewBag.AktualnaStrona - 1, miesiac = ViewBag.WybranyMiesiac, rok = ViewBag.WybranyRok, fraza = Request.QueryString["fraza"] })">Poprzednia</a>
                    </li>
                    <li class="page-item disabled"><span class="page-link">Strona @ViewBag.AktualnaStrona</span></li>
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Raporty", new { strona = ViewBag.AktualnaStrona + 1, miesiac = ViewBag.WybranyMiesiac, rok = ViewBag.WybranyRok, fraza = Request.QueryString["fraza"] })">Następna</a>
                    </li>
                </ul>*@

        </nav>
    </div>
</div>

@* Skrypt obsługujący eksport C# z filtrami *@
<script>
    function pobierzRaport() {
        const urlParams = new URLSearchParams(window.location.search);
        const url = `@Url.Action("EksportujRaport", "Administrator")?` + urlParams.toString();
        window.location.href = url;
    }
</script>



